---
title: "Domino's : Customer Sentiments Analysis Dashboard"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
    runtime: shiny
    logo: logo.png
    storyboard: true
    social: menu
    source: embed
    theme: spacelab
---

```{r setup, include=FALSE}
library(flexdashboard)
require(tidyverse)
require(httr)
require(jsonlite)
require(rlist)
require(stringr)
require(sqldf)
require(ggplot2)
require(beeswarm)
require(googleway)
require(highcharter)
require(quantmod)
require(leaflet)
require(shiny)
require(bslib)
require(plotly)
require(dygraphs)
require(treemap)
require(DT)
require(romato)

thm <- 
  hc_theme(
    colors = c("#1a6ecc", "#434348", "#90ed7d"),
    chart = list(
      backgroundColor = "transparent",
      style = list(fontFamily = "Source Sans Pro")
    ),
    xAxis = list(
      gridLineWidth = 1
    )
  )

client_id <- "oRXG-5EbOsC_XMiFbn-csA"
client_secret <- "MGB45IYKRpTVpbxDdfWccm0PpaLESo1BZMoI9EngKbxOJTfB041SwucvPlgGWWUnCyy22KQ-G1vIrfd5s4N_uyob1u0xQCpYuZYx5uYb3CyZLbO1l1UegYVnwsJSYHYx"
res <- POST("https://api.yelp.com/oauth2/token",
            body = list(grant_type = "client_credentials",
                        client_id = client_id,
                        client_secret = client_secret))

token <- content(res)$access_token

yelp <- "https://api.yelp.com"
location <- "Lincoln, NE"
categories <- NULL
limit <- 50
radius <- 8800
term <- "Domino"
url <- modify_url(yelp, path = c("v3", "businesses", "search"),
                  query = list(term = term, location = location, 
                               limit = limit,
                               radius = radius))
res <- GET(url, add_headers('Authorization' = paste("bearer", client_secret)))

results <- content(res)

yelp_httr_parse <- function(x) {
  
  parse_list <- list(id = x$id, 
                     name = x$name, 
                     rating = x$rating, 
                     review_count = x$review_count, 
                     latitude = x$coordinates$latitude, 
                     longitude = x$coordinates$longitude, 
                     address1 = x$location$address1, 
                     city = x$location$city, 
                     state = x$location$state, 
                     distance = x$distance)
  
  parse_list <- lapply(parse_list, FUN = function(x) ifelse(is.null(x), "", x))
  
  df <- tibble(id=parse_list$id,
                   name=parse_list$name, 
                   rating = parse_list$rating, 
                   review_count = parse_list$review_count, 
                   latitude=parse_list$latitude, 
                   longitude = parse_list$longitude, 
                   address1 = parse_list$address1, 
                   city = parse_list$city, 
                   state = parse_list$state, 
                   distance= parse_list$distance)
  df
}

results_list <- lapply(results$businesses, FUN = yelp_httr_parse)

business_data <- do.call("rbind", results_list)

dominos_data <- business_data[grepl('\\Domino', business_data$name),]

#write.table(dominos_data, "/Users/Abs/Documents/GitHub/R Sample Codes/test2.csv",
#            append = TRUE,
#            sep = ",",
#            col.names = FALSE,
#            row.names = FALSE,
#            quote = FALSE)

df_new <- read.csv(file = '/Users/Abs/Documents/GitHub/R Sample Codes/test2.csv')

zmt <- zomato$new(api_key = "2bfbc4c07e842a726a76cb88d72429c4")

pizza_blr <- zmt$search(query = "Domino", lat = 12.972442, lon = 77.580643)

pizza_aus <- zmt$search(query = "Domino", lat = -33.865143, lon = 151.209900)

```


### Location Markers across Midwest for Domino's Pizza Store featuring Yelp Ratings

```{r}
leaflet(pizza_blr) %>% 
addTiles() %>%
addCircles(lng =df_new$longitude, lat = df_new$latitude, weight = 2,
             radius = df_new$review_count*200, popup=paste(df_new$address1,",",df_new$city," , rating :",df_new$rating," review : ",df_new$review_count)
  )

```

*** 
<p><b>Inference Points :</b></p>
<p>
- Ann Arbor have average rating 3.5 across all stores
- Minneapolis Store has negative sentiments with rating 1.5 with most reviews (94), followed by Indianapolis Store with rating 2 and 60 reviews
</p>
\
&nbsp;
<p><b>References :</b></p>
<p>
- [Yelp API](https://www.yelp.com/developers/documentation/v3)
- [leaflet visual](http://rstudio.github.io/leaflet/shapes.html)
</p>

### Overall distribution of customer reviews across different cities in Midwest along with average customer rating

```{r}
hchart(df_new, "scatter", hcaes(x = review_count, y = rating, z = rating, group = city))
```

*** 
<p><b>Inference Points :</b></p>
<p>
- Ann Arbor have average rating 3.5 across all stores
- Minneapolis Store has negative sentiments with rating 1.5 with most reviews (94), followed by Indianapolis Store with rating 2 and 60 reviews
</p>
\
&nbsp;
<p><b>References :</b></p>
<p>
- [Yelp API](https://www.yelp.com/developers/documentation/v3)
- [Highcharter](https://jkunst.com/highcharter/)
</p>


### Location Markers across Bangalore for Pizza Delivery Store featuring Zomato Ratings

```{r}

leaflet(pizza_blr) %>% 
addTiles() %>%
addCircles(lng =as.numeric(pizza_blr$longitude), lat = as.numeric(pizza_blr$latitude), weight = 2,
             radius = ~sqrt(as.numeric(pizza_blr$votes))*10, popup=paste(pizza_blr$locality," , rating :",pizza_blr$aggregate_rating," votes : ",pizza_blr$votes)
  )

```

*** 
<p><b>Inference Points :</b></p>
<p>
- BTM Layout in Bangalore is rocking it ! With 4.2 rating and 15k votes.
- Soulspace in Marthalli needs to up their game, 3.1 rating around 5k votes.
</p>
\
&nbsp;
<p><b>References :</b></p>
<p>
- [Zomato API](https://developers.zomato.com)
- [leaflet visual](http://rstudio.github.io/leaflet/shapes.html)
</p>


### Overall distribution of Reviews across different localities in Bangalore, India with average customer rating

```{r}
hchart(pizza_blr, "scatter", hcaes(x = as.numeric(votes), y = as.numeric(aggregate_rating), z = as.numeric(aggregate_rating), group = locality))
```

*** 
<p><b>Inference Points :</b></p>
<p>
- BTM Layout in Bangalore is rocking it ! With 4.2 rating and 15k votes.
- Soulspace in Marthalli needs to up their game, 3.1 rating around 5k votes.
</p>
\
&nbsp;
<p><b>References :</b></p>
<p>
- [Zomato API](https://developers.zomato.com)
- [Highcharter](https://jkunst.com/highcharter/)
</p>

### Location Markers across Sydney Australia for Pizza Delivery Store featuring Zomato Ratings

```{r}
leaflet(pizza_blr) %>% 
addTiles() %>%
addCircles(lng =as.numeric(pizza_aus$longitude), lat = as.numeric(pizza_aus$latitude), weight = 2,
             radius = ~sqrt(as.numeric(pizza_aus$votes))*100, popup=paste(pizza_aus$locality," , rating :",pizza_aus$aggregate_rating," votes : ",pizza_aus$votes)
  )

```

*** 
<p><b>Inference Points :</b></p>
<p>
- Sydney Olympic Park seems to be leading ratings 3.4 with 18 reviews.
- Store in Mascot was rated at 2.5 with 22 reviews.
</p>
\
&nbsp;
<p><b>References :</b></p>
<p>
- [Zomato API](https://developers.zomato.com)
- [leaflet visual](http://rstudio.github.io/leaflet/shapes.html)
</p>

### Overall distribution of Reviews across different localities in Sydney, Australia with average customer rating

```{r}
hchart(pizza_aus, "scatter", hcaes(x = as.numeric(votes), y = as.numeric(aggregate_rating), z = as.numeric(aggregate_rating), group = locality))
```


### Detail Yelp Data around reviews and ratings for stores across Midwest Metro City Areas

```{r}
datatable(df_new)
```

### Timeseries Stock analysis on Domino's against its competitors

```{r}
x <- getSymbols("DPZ", auto.assign = FALSE)
y <- getSymbols("YUM", auto.assign = FALSE)
z <- getSymbols("PZZA", auto.assign = FALSE)

highchart(type = "stock") %>% 
  hc_add_series(x) %>% 
  hc_add_series(y) %>%
  hc_add_series(z)
```
